image: python:latest

stages:
    - test
    - deploy

test:
    stage: test

    services:
        - postgres:latest
        - docker:latest

    variables:
        POSTGRES_DB: nice_marmot
        POSTGRES_USER: runner
        POSTGRES_PASSWORD: "test"

    script:
    #Setting-up
    - docker run --name $POSTGRES_USER -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD -d $POSTGRES_D
    - export DATABASE_URL=postgres://$POSTGRES_USER:POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB
    - apt-get update -qy
    - apt-get install -y python-dev python-pip
    - pip install -r requirements.txt
    #Run tests with
    - pytest

deploy:
    stage: deploy
    script:
        - git remote add heroku https://heroku:$HEROKU_API_KEY@git.heroku.com/cianobot.git
        - git push heroku master
        - echo "Deployed to Production Server https://t.me/cianostavernabot"
    environment:
        name: production
        url: https://t.me/cianostavernabot
    when: manual
    only:
        - master
